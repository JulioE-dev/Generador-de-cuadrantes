<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Cuadrantes de Turnos</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            /* Make body take full viewport height */
            height: 100vh;
            overflow: hidden;
        }

        /* Container now uses flexbox and fills viewport */
        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        /* Fixed header, no longer scrolls */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Content area now scrollable and fills remaining space */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .legend {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .legend h2 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .legend ul {
            list-style: none;
            line-height: 1.6;
            font-size: 0.9em;
        }

        .legend ul li {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .legend ul li:last-child {
            border-bottom: none;
        }

        .legend strong {
            color: #667eea;
            min-width: 70px;
            display: inline-block;
        }

        .section {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .employees-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .employee-card {
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-direction: column;
            gap: 8px;
        }

        .employee-card-header {
            display: flex;
            width: 100%;
            justify-content: space-between;
            align-items: center;
        }

        .employee-card span {
            font-weight: 600;
            font-size: 0.9em;
        }

        /* Badge styles for group display */
        .group-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 700;
            margin-left: 6px;
            color: white;
        }

        .group-1 { background: #667eea; }
        .group-2 { background: #28a745; }
        .group-3 { background: #ffc107; color: #333; }

        .group-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }

        .group-header {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .employee-card button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        /* Added checkbox container for extra hours and weekday-only */
        .employee-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 100%;
            font-size: 0.75em;
        }

        .employee-options label {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            font-weight: normal;
        }

        .employee-options input[type="checkbox"] {
            width: auto;
            margin: 0;
        }


        /* Schedule table optimized for full month view */
        .schedule-table {
            overflow-x: auto;
            margin-top: 15px;
            max-height: calc(100vh - 450px);
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 11px;
        }

        th, td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #ddd;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 10px;
        }

        td {
            min-width: 35px;
            font-size: 11px;
        }

        .day-cell {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .day-cell:hover {
            background: #f0f0f0;
        }

        .day-cell.holiday {
            background: #ffe0e0;
        }

        .day-cell.selected {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .shift-D {
            background: #fff3cd;
            font-weight: bold;
        }

        .shift-N {
            background: #cfe2ff;
            font-weight: bold;
        }

        .shift-V {
            background: #d1e7dd;
        }

        .shift-BM {
            background: #f8d7da;
        }

        .shift-PR {
            background: #e7d4f5;
        }

        .shift-C {
            background: #cff4fc;
        }

        .shift-asterisk {
            background: #ffeaa7;
        }

        /* Add new styles for position color coding */
        .position-badge {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 4px;
            border: 1px solid #333;
        }

        .weekend-column {
            background: #ffcccc !important; /* Changed to a lighter red for better contrast */
        }

        .holiday-column {
            background: #ffdddd !important; /* Slightly different shade for holidays */
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h3 {
            color: #667eea;
            margin: 0;
            font-size: 1.2em;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .close:hover {
            color: #333;
        }

        .shift-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .shift-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 13px;
        }

        .shift-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .rules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .alert-success {
            background: #d1e7dd;
            color: #0f5132;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #664d03;
            border-left: 4px solid #ffc107;
        }

        .alert-error {
            background: #f8d7da;
            color: #842029;
            border-left: 4px solid #dc3545;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.4em;
            }

            .employees-list {
                grid-template-columns: 1fr;
            }

            .shift-options {
                grid-template-columns: repeat(2, 1fr);
            }

            th, td {
                padding: 4px 2px;
                font-size: 9px;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóìÔ∏è Generador de Cuadrantes de Turnos</h1>
            <p>Sistema autom√°tico de planificaci√≥n de turnos 2026-2050</p>
        </div>

        <div class="content">
            <!-- Leyenda -->
            <div class="legend">
                <h2>üìã Gu√≠a de Uso</h2>
                <ul>
                    <li><strong>Paso 1:</strong> A√±ade empleados a tu plantilla usando el formulario</li>
                    <li><strong>Paso 2:</strong> Selecciona el mes y a√±o del cuadrante</li>
                    <li><strong>Paso 3:</strong> Define las reglas de trabajo (d√≠as seguidos y d√≠as libres)</li>
                    <li><strong>Paso 4:</strong> Marca estados especiales antes de generar (opcional)</li>
                    <li><strong>Paso 5:</strong> Genera el cuadrante autom√°ticamente o compl√©talo manualmente</li>
                    <li><strong>Paso 6:</strong> Edita el cuadrante si es necesario</li>
                    <li><strong>Paso 7:</strong> Exporta a PDF o Excel</li>
                </ul>
                <h2 style="margin-top: 15px;">üè∑Ô∏è C√≥digos y S√≠mbolos</h2>
                <ul>
                    <li><strong>D:</strong> Turno de D√≠a (7:00 - 19:00)</li>
                    <li><strong>N:</strong> Turno de Noche (19:00 - 7:00)</li>
                    <li><strong>*:</strong> Petici√≥n de d√≠a del empleado</li>
                    <li><strong>V:</strong> Vacaciones</li>
                    <li><strong>BM:</strong> Baja M√©dica</li>
                    <li><strong>PR:</strong> Permiso Retribuido</li>
                    <li><strong>C:</strong> Curso</li>
                    <li><strong>L:</strong> D√≠a Libre</li>
                    <li><strong>üéâ:</strong> Festivo Nacional o Comunidad de Madrid</li>
                </ul>
                <h2 style="margin-top: 15px;">‚öôÔ∏è Reglas Especiales</h2>
                <ul>
                    <li><strong>Horas m√≠nimas:</strong> Todos los empleados deben hacer m√≠nimo 168 horas al mes</li>
                    <li><strong>Horas extra:</strong> Una vez alcanzado el m√≠nimo, las horas restantes se reparten entre empleados que acepten horas extra</li>
                    <li><strong>Trabajador L-V (Grupo 1):</strong> Puedes marcar 1 trabajador del Grupo 1 que solo trabaja lunes a viernes y libra fines de semana y festivos</li>
                    <li><strong>Resto de trabajadores:</strong> Trabajan de lunes a domingo, incluidos festivos</li>
                </ul>
            </div>

            <!-- Secci√≥n 1: Plantilla de Empleados -->
            <div class="section">
                <h3>üë• Plantilla de Empleados</h3>
                <div class="form-group">
                    <label for="employeeName">Nombre del Empleado:</label>
                    <input type="text" id="employeeName" placeholder="Ej: Juan P√©rez">
                </div>
                <!-- Add group selection dropdown -->
                <div class="form-group">
                    <label for="employeeGroup">Grupo:</label>
                    <select id="employeeGroup">
                        <option value="1">Grupo 1 (M√°x. 15 trabajadores)</option>
                        <option value="2">Grupo 2 (M√°x. 5 trabajadores)</option>
                        <option value="3">Grupo 3 (M√°x. 4 trabajadores)</option>
                    </select>
                </div>
                <!-- Add position selection with color -->
                <div class="form-group">
                    <label for="employeePosition">Puesto:</label>
                    <input type="text" id="employeePosition" placeholder="Ej: Enfermero, Auxiliar, etc.">
                </div>
                <div class="form-group">
                    <label for="employeeColor">Color del puesto:</label>
                    <input type="color" id="employeeColor" value="#667eea">
                </div>
                <button class="btn btn-primary" onclick="addEmployee()">‚ûï A√±adir Empleado</button>
                
                <!-- Updated employee list display with groups -->
                <div id="employeesList"></div>
            </div>

            <!-- Secci√≥n 2: Configuraci√≥n del Cuadrante -->
            <div class="section">
                <h3>‚öôÔ∏è Configuraci√≥n del Cuadrante</h3>
                <div class="rules-grid">
                    <div class="form-group">
                        <label for="selectedMonth">Mes:</label>
                        <select id="selectedMonth">
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="selectedYear">A√±o:</label>
                        <select id="selectedYear"></select>
                    </div>
                    <!-- Added checkbox to make work/rest rules optional -->
                    <div class="form-group" style="grid-column: span 2;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="useWorkRestRules" style="width: auto;">
                            Aplicar reglas de d√≠as consecutivos (trabajo/descanso)
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="workDays">D√≠as seguidos a trabajar:</label>
                        <input type="number" id="workDays" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label for="restDays">D√≠as libres consecutivos:</label>
                        <input type="number" id="restDays" value="2" min="1" max="7">
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="generateSchedule()">üöÄ Generar Cuadrante Autom√°tico</button>
                <button class="btn btn-warning" onclick="createEmptySchedule()">üìù Crear Cuadrante Vac√≠o (Manual)</button>
            </div>

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Generando cuadrante...</p>
            </div>

            <!-- Alertas -->
            <div id="alerts"></div>

            <!-- Secci√≥n 3: Cuadrante -->
            <div id="scheduleSection" class="section" style="display: none;">
                <h3>üìÖ Cuadrante de Turnos</h3>
                <div style="margin-bottom: 12px;">
                    <button class="btn btn-danger" onclick="exportToPDF()">üìÑ Exportar a PDF</button>
                    <button class="btn btn-success" onclick="exportToExcel()">üìä Exportar a Excel</button>
                    <button class="btn btn-info" onclick="enableEditMode()">‚úèÔ∏è Modo Edici√≥n</button>
                </div>
                <div class="schedule-table">
                    <table id="scheduleTable"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar celda -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Turno</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <p id="modalInfo"></p>
            <div class="shift-options">
                <button class="shift-btn shift-D" onclick="setCellValue('D')">D - D√≠a</button>
                <button class="shift-btn shift-N" onclick="setCellValue('N')">N - Noche</button>
                <button class="shift-btn" onclick="setCellValue('L')">L - Libre</button>
                <button class="shift-btn shift-asterisk" onclick="setCellValue('*')">* - Petici√≥n</button>
                <button class="shift-btn shift-V" onclick="setCellValue('V')">V - Vacaciones</button>
                <button class="shift-btn shift-BM" onclick="setCellValue('BM')">BM - Baja</button>
                <button class="shift-btn shift-PR" onclick="setCellValue('PR')">PR - Permiso</button>
                <button class="shift-btn shift-C" onclick="setCellValue('C')">C - Curso</button>
                <button class="shift-btn" onclick="setCellValue('')">üóëÔ∏è Limpiar</button>
            </div>
        </div>
    </div>

    <script>
        // Estado global
        let employees = []; // Now stores objects: {name, group, position, color, wantsExtraHours: false, weekdaysOnly: false}
        let schedule = {};
        let currentMonth = 0;
        let currentYear = 2026;
        let editMode = false;
        let selectedCell = null;

        const GROUP_LIMITS = {
            1: 15,
            2: 5,
            3: 4
        };

        const MIN_HOURS_PER_MONTH = 168; // Minimum hours per employee per month

        // Festivos de Espa√±a y Madrid
        const holidays = {
            // Festivos nacionales fijos
            fixed: [
                { month: 0, day: 1, name: "A√±o Nuevo" },
                { month: 0, day: 6, name: "D√≠a de Reyes" },
                { month: 4, day: 1, name: "D√≠a del Trabajo" },
                { month: 7, day: 15, name: "Asunci√≥n de la Virgen" },
                { month: 9, day: 12, name: "Fiesta Nacional de Espa√±a" },
                { month: 10, day: 1, name: "Todos los Santos" },
                { month: 11, day: 6, name: "D√≠a de la Constituci√≥n" },
                { month: 11, day: 8, name: "Inmaculada Concepci√≥n" },
                { month: 11, day: 25, name: "Navidad" },
                // Madrid
                { month: 4, day: 2, name: "Fiesta de la Comunidad de Madrid" },
                { month: 4, day: 15, name: "San Isidro" }
            ],
            // Festivos m√≥viles (Semana Santa principalmente)
            movable: {
                2026: [
                    { month: 3, day: 3, name: "Viernes Santo" },
                    { month: 3, day: 6, name: "Lunes de Pascua" }
                ],
                2027: [
                    { month: 2, day: 26, name: "Viernes Santo" },
                    { month: 2, day: 29, name: "Lunes de Pascua" }
                ],
                2028: [
                    { month: 3, day: 14, name: "Viernes Santo" },
                    { month: 3, day: 17, name: "Lunes de Pascua" }
                ],
                2029: [
                    { month: 2, day: 30, name: "Viernes Santo" },
                    { month: 3, day: 2, name: "Lunes de Pascua" }
                ],
                2030: [
                    { month: 3, day: 19, name: "Viernes Santo" },
                    { month: 3, day: 22, name: "Lunes de Pascua" }
                ]
            }
        };

        // Inicializaci√≥n
        function init() {
            populateYears();
            const now = new Date();
            document.getElementById('selectedMonth').value = now.getMonth();
            document.getElementById('selectedYear').value = now.getFullYear() >= 2026 ? now.getFullYear() : 2026;
        }

        function populateYears() {
            const yearSelect = document.getElementById('selectedYear');
            for (let year = 2026; year <= 2050; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        function showAlert(message, type) {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertsDiv.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Gesti√≥n de empleados
        function addEmployee() {
            const nameInput = document.getElementById('employeeName');
            const groupSelect = document.getElementById('employeeGroup');
            const positionInput = document.getElementById('employeePosition');
            const colorInput = document.getElementById('employeeColor');
            // </CHANGE>
            const name = nameInput.value.trim();
            const group = parseInt(groupSelect.value);
            const position = positionInput.value.trim() || 'Sin puesto';
            const color = colorInput.value;
            // </CHANGE>
            
            if (!name) {
                showAlert('Por favor, introduce un nombre v√°lido', 'warning');
                return;
            }
            
            if (employees.some(emp => emp.name === name)) {
                showAlert('Este empleado ya existe', 'warning');
                return;
            }
            
            const groupCount = employees.filter(emp => emp.group === group).length;
            if (groupCount >= GROUP_LIMITS[group]) {
                showAlert(`El Grupo ${group} ya tiene el m√°ximo de trabajadores (${GROUP_LIMITS[group]})`, 'error');
                return;
            }
            
            employees.push({ 
                name, 
                group,
                position,
                color,
                wantsExtraHours: false,
                weekdaysOnly: false
            });
            // </CHANGE>
            nameInput.value = '';
            positionInput.value = '';
            // </CHANGE>
            renderEmployeesList();
            showAlert(`Empleado "${name}" a√±adido al Grupo ${group}`, 'success');
        }

        function removeEmployee(index) {
            const employee = employees[index];
            employees.splice(index, 1);
            delete schedule[employee.name];
            renderEmployeesList();
            showAlert(`Empleado "${employee.name}" eliminado`, 'success');
        }

        function toggleExtraHours(index) {
            employees[index].wantsExtraHours = !employees[index].wantsExtraHours;
            renderEmployeesList();
        }

        function toggleWeekdaysOnly(index) {
            const employee = employees[index];
            
            // Only one employee in Group 1 can be weekdays-only
            if (!employee.weekdaysOnly) {
                const hasWeekdayWorker = employees.some(emp => emp.group === 1 && emp.weekdaysOnly);
                if (hasWeekdayWorker) {
                    showAlert('Ya hay un trabajador del Grupo 1 marcado como Lunes-Viernes', 'warning');
                    return;
                }
            }
            
            employees[index].weekdaysOnly = !employees[index].weekdaysOnly;
            renderEmployeesList();
        }

        function renderEmployeesList() {
            const listDiv = document.getElementById('employeesList');
            
            if (employees.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: #999;">No hay empleados en la plantilla</p>';
                return;
            }
            
            let html = '';
            
            for (let groupNum = 1; groupNum <= 3; groupNum++) {
                const groupEmployees = employees.filter(emp => emp.group === groupNum);
                
                if (groupEmployees.length > 0) {
                    const groupCount = groupEmployees.length;
                    const maxCount = GROUP_LIMITS[groupNum];
                    
                    html += `
                        <div class="group-section">
                            <div class="group-header">
                                <span class="group-badge group-${groupNum}">GRUPO ${groupNum}</span>
                                <span style="font-size: 0.85em; color: #666;">(${groupCount}/${maxCount} trabajadores)</span>
                            </div>
                            <div class="employees-list">
                    `;
                    
                    groupEmployees.forEach((emp) => {
                        const index = employees.indexOf(emp);
                        html += `
                            <div class="employee-card">
                                <div class="employee-card-header">
                                    <!-- Add position badge with color -->
                                    <span>${emp.name} <span class="position-badge" style="background: ${emp.color};" title="${emp.position}"></span></span>
                                    <!-- </CHANGE> -->
                                    <button onclick="removeEmployee(${index})">‚ùå</button>
                                </div>
                                <!-- Display position info -->
                                <div style="font-size: 0.7em; color: #666; width: 100%;">${emp.position}</div>
                                <!-- </CHANGE> -->
                                <div class="employee-options">
                                    <label>
                                        <input type="checkbox" ${emp.wantsExtraHours ? 'checked' : ''} 
                                               onchange="toggleExtraHours(${index})">
                                        ‚è∞ Acepta horas extra
                                    </label>
                        `;
                        
                        if (groupNum === 1) {
                            html += `
                                    <label>
                                        <input type="checkbox" ${emp.weekdaysOnly ? 'checked' : ''} 
                                               onchange="toggleWeekdaysOnly(${index})">
                                        üìÖ Solo Lunes-Viernes
                                    </label>
                            `;
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
            }
            
            listDiv.innerHTML = html;
        }

        // Verificar si es festivo
        function isHoliday(year, month, day) {
            // Festivos fijos
            const isFixed = holidays.fixed.some(h => h.month === month && h.day === day);
            
            // Festivos m√≥viles
            const yearHolidays = holidays.movable[year] || [];
            const isMovable = yearHolidays.some(h => h.month === month && h.day === day);
            
            return isFixed || isMovable;
        }

        function isWeekend(year, month, day) {
            const date = new Date(year, month, day);
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6; // Sunday or Saturday
        }

        function getRequiredStaff(isWeekendOrHoliday, shift) {
            // GRUPO 1: L-V D√≠a: 3 (con fijo), L-V Noche: 2, F.Semana/Festivos D√≠a: 2, Noche: 2
            // GRUPO 2: L-V D√≠a: 1, L-V Noche: 1, F.Semana/Festivos D√≠a: 2, Noche: 1
            // GRUPO 3: Todos los d√≠as D√≠a: 1, Noche: 1
            if (shift === 'D') {
                // Day shift
                if (isWeekendOrHoliday) {
                    // Weekend/Holiday morning: 2 from group 1, 2 from group 2, 1 from group 3
                    return { 1: 2, 2: 2, 3: 1 };
                } else {
                    // Weekday morning: 3 from group 1 (including fixed employee), 1 from group 2, 1 from group 3
                    return { 1: 3, 2: 1, 3: 1 };
                }
            } else if (shift === 'N') {
                // Night shift: 2 from group 1, 1 from group 2, 1 from group 3 (all days)
                return { 1: 2, 2: 1, 3: 1 };
            }
            return { 1: 0, 2: 0, 3: 0 };
        }

        function canWorkOnDay(employeeName, day) {
            const useRules = document.getElementById('useWorkRestRules').checked;
            
            if (!useRules) {
                return true; // No restrictions if rules are disabled
            }
            
            // Check if employee worked in the last 3 days or will work in next 3 days
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Look back 3 days
            for (let i = 1; i <= 3; i++) {
                const checkDay = day - i;
                if (checkDay >= 1) {
                    const value = schedule[employeeName] && schedule[employeeName][checkDay];
                    if (value === 'D' || value === 'N') {
                        return false; // Worked recently, needs rest
                    }
                }
            }
            return true;
        }

        function assignShiftsWithCoverage() {
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const useWorkRestRules = document.getElementById('useWorkRestRules').checked;
            
            // Initialize schedule
            schedule = {};
            employees.forEach(emp => {
                schedule[emp.name] = {};
                for (let day = 1; day <= daysInMonth; day++) {
                    schedule[emp.name][day] = 'L'; // Start all as free
                }
            });

            // First, assign the fixed weekdays-only employee
            const fixedEmployee = employees.find(emp => emp.weekdaysOnly && emp.group === 1);
            if (fixedEmployee) {
                for (let day = 1; day <= daysInMonth; day++) {
                    const isWeekendDay = isWeekend(currentYear, currentMonth, day);
                    const isHolidayDay = isHoliday(currentYear, currentMonth, day);
                    
                    if (!isWeekendDay && !isHolidayDay) {
                        schedule[fixedEmployee.name][day] = 'D'; // Always day shift on weekdays
                    }
                    // Weekends and holidays remain 'L' (free)
                }
            }

            // Separate employees by group (excluding the fixed employee for rotation)
            const group1 = employees.filter(emp => emp.group === 1 && !(emp.weekdaysOnly && emp === fixedEmployee));
            const group2 = employees.filter(emp => emp.group === 2);
            const group3 = employees.filter(emp => emp.group === 3);

            // Track consecutive work days for each employee (only if rules enabled)
            const consecutiveWork = {};
            const consecutiveRest = {};
            employees.forEach(emp => {
                consecutiveWork[emp.name] = 0;
                consecutiveRest[emp.name] = 0;
            });

            const workDays = parseInt(document.getElementById('workDays').value) || 3;
            const restDays = parseInt(document.getElementById('restDays').value) || 2;

            // For each day, assign required staff per group and shift
            for (let day = 1; day <= daysInMonth; day++) {
                const isWeekendOrHoliday = isWeekend(currentYear, currentMonth, day) || isHoliday(currentYear, currentMonth, day);
                
                // Get required staff for day and night shifts
                const dayRequired = getRequiredStaff(isWeekendOrHoliday, 'D');
                const nightRequired = getRequiredStaff(isWeekendOrHoliday, 'N');

                // Assign shifts for Group 1
                let g1DayCount = fixedEmployee && !isWeekendOrHoliday ? 1 : 0; // Count fixed employee if working
                const availableG1 = group1.filter(emp => schedule[emp.name][day] === 'L');
                
                // Day shift group 1 (need to reach dayRequired[1] total, including fixed employee)
                const g1DayNeeded = dayRequired[1] - g1DayCount;
                for (let i = 0; i < g1DayNeeded && i < availableG1.length; i++) {
                    const emp = availableG1[i];
                    if (useWorkRestRules && consecutiveWork[emp.name] >= workDays) {
                        continue; // Needs rest
                    }
                    schedule[emp.name][day] = 'D';
                    if (useWorkRestRules) {
                        consecutiveWork[emp.name]++;
                        consecutiveRest[emp.name] = 0;
                    }
                }

                // Night shift group 1
                const availableG1Night = group1.filter(emp => schedule[emp.name][day] === 'L');
                for (let i = 0; i < nightRequired[1] && i < availableG1Night.length; i++) {
                    const emp = availableG1Night[i];
                    if (useWorkRestRules && consecutiveWork[emp.name] >= workDays) {
                        continue;
                    }
                    schedule[emp.name][day] = 'N';
                    if (useWorkRestRules) {
                        consecutiveWork[emp.name]++;
                        consecutiveRest[emp.name] = 0;
                    }
                }

                // Update rest days for Group 1 employees who didn't work
                if (useWorkRestRules) {
                    group1.forEach(emp => {
                        if (schedule[emp.name][day] === 'L') {
                            consecutiveRest[emp.name]++;
                            if (consecutiveRest[emp.name] >= restDays) {
                                consecutiveWork[emp.name] = 0; // Reset work counter after sufficient rest
                            }
                        }
                    });
                }

                // Assign shifts for Group 2
                const availableG2Day = group2.filter(emp => schedule[emp.name][day] === 'L');
                for (let i = 0; i < dayRequired[2] && i < availableG2Day.length; i++) {
                    const emp = availableG2Day[i];
                    if (useWorkRestRules && consecutiveWork[emp.name] >= workDays) {
                        continue;
                    }
                    schedule[emp.name][day] = 'D';
                    if (useWorkRestRules) {
                        consecutiveWork[emp.name]++;
                        consecutiveRest[emp.name] = 0;
                    }
                }

                const availableG2Night = group2.filter(emp => schedule[emp.name][day] === 'L');
                for (let i = 0; i < nightRequired[2] && i < availableG2Night.length; i++) {
                    const emp = availableG2Night[i];
                    if (useWorkRestRules && consecutiveWork[emp.name] >= workDays) {
                        continue;
                    }
                    schedule[emp.name][day] = 'N';
                    if (useWorkRestRules) {
                        consecutiveWork[emp.name]++;
                        consecutiveRest[emp.name] = 0;
                    }
                }

                if (useWorkRestRules) {
                    group2.forEach(emp => {
                        if (schedule[emp.name][day] === 'L') {
                            consecutiveRest[emp.name]++;
                            if (consecutiveRest[emp.name] >= restDays) {
                                consecutiveWork[emp.name] = 0;
                            }
                        }
                    });
                }

                // Assign shifts for Group 3
                const availableG3Day = group3.filter(emp => schedule[emp.name][day] === 'L');
                for (let i = 0; i < dayRequired[3] && i < availableG3Day.length; i++) {
                    const emp = availableG3Day[i];
                    if (useWorkRestRules && consecutiveWork[emp.name] >= workDays) {
                        continue;
                    }
                    schedule[emp.name][day] = 'D';
                    if (useWorkRestRules) {
                        consecutiveWork[emp.name]++;
                        consecutiveRest[emp.name] = 0;
                    }
                }

                const availableG3Night = group3.filter(emp => schedule[emp.name][day] === 'L');
                for (let i = 0; i < nightRequired[3] && i < availableG3Night.length; i++) {
                    const emp = availableG3Night[i];
                    if (useWorkRestRules && consecutiveWork[emp.name] >= workDays) {
                        continue;
                    }
                    schedule[emp.name][day] = 'N';
                    if (useWorkRestRules) {
                        consecutiveWork[emp.name]++;
                        consecutiveRest[emp.name] = 0;
                    }
                }

                if (useWorkRestRules) {
                    group3.forEach(emp => {
                        if (schedule[emp.name][day] === 'L') {
                            consecutiveRest[emp.name]++;
                            if (consecutiveRest[emp.name] >= restDays) {
                                consecutiveWork[emp.name] = 0;
                            }
                        }
                    });
                }
            }
        }
        // </CHANGE>

        // Generar cuadrante autom√°tico
        function generateSchedule() {
            if (employees.length === 0) {
                showAlert('Debes a√±adir al menos un empleado', 'error');
                return;
            }

            currentMonth = parseInt(document.getElementById('selectedMonth').value);
            currentYear = parseInt(document.getElementById('selectedYear').value);

            document.getElementById('loading').style.display = 'block';

            setTimeout(() => {
                assignShiftsWithCoverage();

                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                
                // Calculate current hours for each employee
                const hoursCount = {};
                employees.forEach(emp => {
                    hoursCount[emp.name] = 0;
                    for (let day = 1; day <= daysInMonth; day++) {
                        const value = schedule[emp.name] && schedule[emp.name][day];
                        if (value === 'D' || value === 'N') {
                            hoursCount[emp.name] += 12;
                        }
                    }
                });

                // First pass: Ensure everyone reaches 168 hours minimum
                let attempts = 0;
                const maxAttempts = 100;
                while (attempts < maxAttempts) {
                    let allAtMinimum = true;
                    
                    for (const emp of employees) {
                        if (hoursCount[emp.name] < MIN_HOURS_PER_MONTH) {
                            allAtMinimum = false;
                            
                            // Try to find a free day where they can work
                            for (let day = 1; day <= daysInMonth; day++) {
                                const currentValue = schedule[emp.name][day];
                                
                                if (currentValue === 'L') {
                                    // Check if it's not a weekend/holiday for weekdays-only employees
                                    if (emp.weekdaysOnly && (isWeekend(currentYear, currentMonth, day) || isHoliday(currentYear, currentMonth, day))) {
                                        continue;
                                    }
                                    
                                    // Check 3-day rest rule
                                    if (!canWorkOnDay(emp.name, day)) {
                                        continue;
                                    }
                                    
                                    // Assign a shift (prefer day shift)
                                    schedule[emp.name][day] = 'D';
                                    hoursCount[emp.name] += 12;
                                    
                                    if (hoursCount[emp.name] >= MIN_HOURS_PER_MONTH) {
                                        break;
                                    }
                                }
                            }
                        }
                    }
                    
                    if (allAtMinimum) break;
                    attempts++;
                }

                // Second pass: Distribute extra hours to employees who want them
                const employeesWantingExtra = employees.filter(emp => emp.wantsExtraHours);
                
                if (employeesWantingExtra.length > 0) {
                    let extraHoursDistributed = 0;
                    const maxExtraShifts = 10; // Limit extra shifts
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        for (const emp of employeesWantingExtra) {
                            if (hoursCount[emp.name] >= MIN_HOURS_PER_MONTH && extraHoursDistributed < maxExtraShifts) {
                                const currentValue = schedule[emp.name][day];
                                
                                if (currentValue === 'L') {
                                    // Check if it's not a weekend/holiday for weekdays-only employees
                                    if (emp.weekdaysOnly && (isWeekend(currentYear, currentMonth, day) || isHoliday(currentYear, currentMonth, day))) {
                                        continue;
                                    }
                                    
                                    // Check 3-day rest rule
                                    if (!canWorkOnDay(emp.name, day)) {
                                        continue;
                                    }
                                    
                                    // Assign a shift
                                    const shift = Math.random() > 0.5 ? 'D' : 'N';
                                    schedule[emp.name][day] = shift;
                                    hoursCount[emp.name] += 12;
                                    extraHoursDistributed++;
                                }
                            }
                        }
                    }
                }
                // </CHANGE>

                document.getElementById('loading').style.display = 'none';
                renderSchedule();
                showAlert('Cuadrante generado correctamente con reglas de cobertura y horas', 'success');
            }, 500);
        }

        // Crear cuadrante vac√≠o
        function createEmptySchedule() {
            if (employees.length === 0) {
                showAlert('Debes a√±adir al menos un empleado', 'error');
                return;
            }

            currentMonth = parseInt(document.getElementById('selectedMonth').value);
            currentYear = parseInt(document.getElementById('selectedYear').value);

            schedule = {};
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            employees.forEach(employee => {
                schedule[employee.name] = {};
                for (let day = 1; day <= daysInMonth; day++) {
                    schedule[employee.name][day] = '';
                }
            });

            renderSchedule();
            enableEditMode();
            showAlert('Cuadrante vac√≠o creado. Modo edici√≥n activado', 'success');
        }

        // Renderizar cuadrante
        function renderSchedule() {
            const table = document.getElementById('scheduleTable');
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

            let html = '<thead><tr><th>Empleado</th>';
            
            // Encabezados de d√≠as
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const dayName = ['D', 'L', 'M', 'X', 'J', 'V', 'S'][date.getDay()];
                const holidayMark = isHoliday(currentYear, currentMonth, day) ? 'üéâ' : '';
                const isWeek = isWeekend(currentYear, currentMonth, day);
                const isHol = isHoliday(currentYear, currentMonth, day);
                const columnClass = (isWeek || isHol) ? 'style="background: #ff6b6b; color: white;"' : ''; // Changed to a lighter red for better contrast
                html += `<th ${columnClass}>${day}<br>${dayName}${holidayMark}</th>`;
            }
            // </CHANGE>
            
            html += '<th style="background: #28a745;">Total<br>Horas</th>';
            html += '</tr></thead><tbody>';

            for (let groupNum = 1; groupNum <= 3; groupNum++) {
                const groupEmployees = employees.filter(emp => emp.group === groupNum);
                
                if (groupEmployees.length > 0) {
                    // Add group header row
                    html += `<tr><td colspan="${daysInMonth + 2}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; text-align: center; padding: 8px;">
                        GRUPO ${groupNum}
                    </td></tr>`;
                    
                    groupEmployees.forEach(employee => {
                        let empNameDisplay = employee.name;
                        if (employee.weekdaysOnly) empNameDisplay += ' üìÖ';
                        if (employee.wantsExtraHours) empNameDisplay += ' ‚è∞';
                        empNameDisplay += ` <span class="position-badge" style="background: ${employee.color};" title="${employee.position}"></span>`;
                        // </CHANGE>
                        
                        html += `<tr><td style="font-weight: 600; background: #f8f9fa;">${empNameDisplay}</td>`;
                        
                        let totalHours = 0;
                        
                        for (let day = 1; day <= daysInMonth; day++) {
                            const value = schedule[employee.name] && schedule[employee.name][day] || '';
                            const isHol = isHoliday(currentYear, currentMonth, day);
                            const isWeek = isWeekend(currentYear, currentMonth, day);
                            const columnClass = (isWeek || isHol) ? 'weekend-column' : ''; // Changed class name to match CSS
                            const shiftClass = value ? `shift-${value}` : '';
                            
                            html += `<td class="day-cell ${columnClass} ${shiftClass}" 
                                        data-employee="${employee.name}" 
                                        data-day="${day}"
                                        onclick="editCell(this)">${value}</td>`;
                            
                            if (value === 'D' || value === 'N') {
                                totalHours += 12;
                            }
                        }
                        // </CHANGE>
                        
                        const bgColor = totalHours < MIN_HOURS_PER_MONTH ? '#f8d7da' : '#d1e7dd';
                        html += `<td style="font-weight: 700; background: ${bgColor};">${totalHours}h</td>`;
                        html += '</tr>';
                    });
                }
            }

            html += '</tbody>';
            table.innerHTML = html;

            document.getElementById('scheduleSection').style.display = 'block';
        }

        // Modo edici√≥n
        function enableEditMode() {
            editMode = !editMode;
            const btn = event.target;
            
            if (editMode) {
                btn.textContent = '‚úÖ Guardar Cambios';
                btn.className = 'btn btn-success';
                showAlert('Modo edici√≥n activado. Haz clic en cualquier celda para editarla', 'success');
            } else {
                btn.textContent = '‚úèÔ∏è Modo Edici√≥n';
                btn.className = 'btn btn-info';
                showAlert('Cambios guardados', 'success');
            }
        }

        // Editar celda
        function editCell(cell) {
            if (!editMode) return;

            selectedCell = cell;
            const employee = cell.dataset.employee;
            const day = cell.dataset.day;
            const date = new Date(currentYear, currentMonth, parseInt(day));
            const dateStr = date.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            document.getElementById('modalInfo').textContent = 
                `Empleado: ${employee} - ${dateStr}`;
            document.getElementById('editModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            selectedCell = null;
        }

        function updateEmployeeTotalHours(employeeName) {
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            let totalHours = 0;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const value = schedule[employeeName] && schedule[employeeName][day];
                if (value === 'D' || value === 'N') {
                    totalHours += 12;
                }
            }
            
            // Find the total hours cell for this employee and update it
            const table = document.getElementById('scheduleTable');
            const rows = table.getElementsByTagName('tr');
            
            for (let row of rows) {
                const firstCell = row.cells[0];
                if (firstCell && firstCell.textContent.includes(employeeName)) {
                    const totalCell = row.cells[row.cells.length - 1];
                    const bgColor = totalHours < MIN_HOURS_PER_MONTH ? '#f8d7da' : '#d1e7dd';
                    totalCell.style.background = bgColor;
                    totalCell.textContent = `${totalHours}h`;
                    break;
                }
            }
        }
        // </CHANGE>

        function setCellValue(value) {
            if (!selectedCell) return;

            const employee = selectedCell.dataset.employee;
            const day = parseInt(selectedCell.dataset.day);

            schedule[employee][day] = value;
            selectedCell.textContent = value;
            
            // Actualizar clases
            selectedCell.className = 'day-cell';
            const isWeek = isWeekend(currentYear, currentMonth, day);
            const isHol = isHoliday(currentYear, currentMonth, day);
            if (isWeek || isHol) {
                selectedCell.classList.add(isHol ? 'holiday-column' : 'weekend-column'); // Apply correct class based on holiday or weekend
            }
            if (value) {
                selectedCell.classList.add(`shift-${value}`);
            }
            
            updateEmployeeTotalHours(employee);
            // </CHANGE>
            
            closeModal();
            showAlert('Turno actualizado', 'success');
        }

        // Exportar a PDF
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');
            
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            doc.setFontSize(16);
            doc.text(`Cuadrante de Turnos - ${monthNames[currentMonth]} ${currentYear}`, 14, 15);
            
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const dayHeaders = Array.from({length: daysInMonth}, (_, i) => i + 1);
            const headers = [['Empleado', 'Puesto', ...dayHeaders, 'Total Horas']];
            // </CHANGE>
            
            const data = [];
            
            for (let groupNum = 1; groupNum <= 3; groupNum++) {
                const groupEmployees = employees.filter(emp => emp.group === groupNum);
                
                if (groupEmployees.length > 0) {
                    // Add group header
                    data.push([`GRUPO ${groupNum}`, '', ...Array(daysInMonth).fill(''), '']);
                    // </CHANGE>
                    
                    groupEmployees.forEach(emp => {
                        const row = [emp.name, emp.position];
                        // </CHANGE>
                        let totalHours = 0;
                        
                        for (let day = 1; day <= daysInMonth; day++) {
                            const value = schedule[emp.name] && schedule[emp.name][day] || '';
                            row.push(value);
                            
                            if (value === 'D' || value === 'N') {
                                totalHours += 12;
                            }
                        }
                        
                        row.push(`${totalHours}h`);
                        data.push(row);
                    });
                }
            }

            doc.autoTable({
                head: headers,
                body: data,
                startY: 20,
                styles: { fontSize: 8, cellPadding: 2 },
                headStyles: { fillColor: [102, 126, 234] },
                margin: { left: 14, right: 14 }
            });

            doc.save(`cuadrante_${monthNames[currentMonth]}_${currentYear}.pdf`);
            showAlert('PDF exportado correctamente', 'success');
        }

        // Exportar a Excel
        function exportToExcel() {
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            const data = [];
            
            const headers = ['Empleado', 'Puesto'];
            // </CHANGE>
            for (let day = 1; day <= daysInMonth; day++) {
                headers.push(day);
            }
            headers.push('Total Horas');
            data.push(headers);
            
            for (let groupNum = 1; groupNum <= 3; groupNum++) {
                const groupEmployees = employees.filter(emp => emp.group === groupNum);
                
                if (groupEmployees.length > 0) {
                    // Add group header
                    data.push([`GRUPO ${groupNum}`, '', ...Array(daysInMonth).fill(''), '']);
                    // </CHANGE>
                    
                    groupEmployees.forEach(emp => {
                        const row = [emp.name, emp.position];
                        // </CHANGE>
                        let totalHours = 0;
                        
                        for (let day = 1; day <= daysInMonth; day++) {
                            const value = schedule[emp.name] && schedule[emp.name][day] || '';
                            row.push(value);
                            
                            if (value === 'D' || value === 'N') {
                                totalHours += 12;
                            }
                        }
                        
                        row.push(`${totalHours}h`);
                        data.push(row);
                    });
                }
            }

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `${monthNames[currentMonth]}`);
            
            XLSX.writeFile(wb, `cuadrante_${monthNames[currentMonth]}_${currentYear}.xlsx`);
            showAlert('Excel exportado correctamente', 'success');
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Inicializar al cargar
        init();
    </script>
</body>
</html>
